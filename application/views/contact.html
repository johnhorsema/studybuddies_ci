<?php
$date = $userName = $userComment = $userEmail = $userPhone = $userMsg = "";
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $userName = $_POST["userName"];
    $userComment = $_POST["userComment"];

    $sql = "INSERT INTO comments (name, content)
            VALUES (".$this->db->escape($userName).", ".$this->db->escape($userComment).")";
    $this->db->query($sql);
}
?>

<div class="container top-margin">
    <div class="page-header">
    <h1>Contact Us <small>reach out to us</small></h1>
    </div>
    <section class="featured">
        <div class="contact-section-comment"> 
            <div class="row mar-bot40">
                <div class="col-md-6 col-md-offset-3">
                    <div class="align-center">
                    <div class="col-lg-12">
                        <h2 class="slogan">Comment</h2>
                        <p>
                        What's on your mind?<br>Give us a comment.
                        </p>
                        <div class="row">
                                <div class="col-md-12">
                                    <form data-toggle="validator" role="form" method="POST" action="<?php echo current_url();?>">
                                        <div class="form-group">
                                            <input type="text" class="form-control" name="userName" placeholder="Your Name *" minlength="10" maxlength="20" required>
                                        </div>
                                        <div class="form-group">
                                            <textarea type="text" class="form-control" name="userComment" placeholder="Write your comment here... *" minlength="10" maxlength="200" required></textarea>
                                        </div>
                                        <div class="form-group">
                                            <span class="input-group-btn" onclick="addComment()">     
                                                <button type="submit" class="btn btn-primary">Add Comment</button>
                                            </span>
                                        </div>
                                    </form>
                                </div>
                                <div class="clearfix"></div>
                                <div class="col-md-12 comment-body">
                                    <ul data-brackets-id="12674" id="sortable" class="list-unstyled ui-sortable">
                                        <?php
                                            function calcTiming ($time){
                                                $timed = time() - strtotime($time);

                                                $tokens = array (
                                                    31536000 => 'year',
                                                    2592000 => 'month',
                                                    604800 => 'week',
                                                    86400 => 'day',
                                                    3600 => 'hour',
                                                    60 => 'minute',
                                                    1 => 'second'
                                                );

                                                foreach ($tokens as $unit => $text) {
                                                    if ($timed < $unit) continue;
                                                    $timed = $timed / $unit;
                                                    $numberOfUnits = floor($timed);
                                                    return $numberOfUnits.' '.$text.(($numberOfUnits>1)?'s':'').' ago';
                                                }
                                            }

                                            $query = $this->db->query('SELECT name, content, timestamp FROM comments ORDER BY id DESC LIMIT 5');
                                            if($query->num_rows() > 0){
                                                foreach ($query->result() as $entry){
                                                    echo '<strong class="pull-left primary-font">'.$entry->name.'</strong>';
                                                    echo '<small class="pull-right">'.calcTiming($entry->timestamp).'</small><br>';
                                                    echo '<li class="ui-state-default">'.$entry->content.'</li>';
                                                }
                                            }
                                            else{echo '<p>Fill the comment board up!</p>';};
                                        ?>
                                    </ul>
                                </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="contact-section-message top-margin"> 
            <div class="row mar-bot40">
                <div class="col-md-6 col-md-offset-3">
                    <div class="align-center">
                    <div class="col-lg-12">
                        <h2 class="slogan">Message</h2>
                        <p>
                        Send us a message.
                        </p>
                        <form name="sentMessage" id="messageForm" novalidate>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <input type="text" class="form-control" placeholder="Your Name *" id="name" required data-validation-required-message="Please enter your name.">
                                        <p class="help-block text-danger"></p>
                                    </div>
                                    <div class="form-group">
                                        <input type="email" class="form-control" placeholder="Your Email *" id="email" required data-validation-required-message="Please enter your email address.">
                                        <p class="help-block text-danger"></p>
                                    </div>
                                    <div class="form-group">
                                        <input type="tel" class="form-control" placeholder="Your Phone *" id="phone" required data-validation-required-message="Please enter your phone number.">
                                        <p class="help-block text-danger"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <textarea class="form-control" placeholder="Your Message *" id="message" required data-validation-required-message="Please enter a message."></textarea>
                                        <p class="help-block text-danger"></p>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                                <div class="col-lg-12 text-center">
                                    <div id="success"></div>
                                    <button type="submit" class="btn btn-primary btn-xl">Send Message</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </section>
    <script src="<?php echo base_url();?>js/validator.js"></script>